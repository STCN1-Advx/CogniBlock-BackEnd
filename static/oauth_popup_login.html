<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth å¼¹çª—ç™»å½•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .user-info {
            text-align: left;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        
        .user-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .user-info p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .api-test {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: left;
        }
        
        .api-test h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .test-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        
        .test-btn:hover {
            background: #218838;
        }
        
        .api-result {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .env-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px;
            border: 1px solid;
        }
        
        .env-indicator.development {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .env-indicator.production {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">CB</div>
        <h1>CogniBlock</h1>
        <p class="subtitle">æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹</p>
        <div id="envIndicator" class="env-indicator"></div>
        
        <button id="loginBtn" class="login-btn">OAuth ç™»å½•</button>
        
        <div id="status" class="status" style="display: none;"></div>
        <div id="userInfo" class="user-info" style="display: none;"></div>
        <div id="apiTest" class="api-test" style="display: none;"></div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            // ç”Ÿäº§ç¯å¢ƒAPIåœ°å€
            API_BASE: 'https://api.cb.smart-teach.cn',
            // å¼€å‘ç¯å¢ƒAPIåœ°å€
            DEV_API_BASE: 'http://localhost:8001',
            // æ™ºèƒ½ç¯å¢ƒæ£€æµ‹
            getApiBase() {
                const hostname = window.location.hostname;
                const port = window.location.port;
                
                // æ£€æµ‹æ˜¯å¦ä¸ºæœ¬åœ°å¼€å‘ç¯å¢ƒ
                const isLocalDev = (
                    hostname === 'localhost' ||
                    hostname === '127.0.0.1' ||
                    hostname === '0.0.0.0' ||
                    hostname.startsWith('192.168.') ||
                    hostname.startsWith('10.') ||
                    hostname.endsWith('.local')
                );
                
                if (isLocalDev) {
                    // å¦‚æœå½“å‰é¡µé¢æœ‰ç«¯å£å·ï¼Œå°è¯•ä½¿ç”¨ç›¸åŒç«¯å£çš„API
                    if (port && port !== '80' && port !== '443') {
                        return `${window.location.protocol}//${hostname}:${port}`;
                    }
                    return this.DEV_API_BASE;
                }
                
                return this.API_BASE;
            }
        };

        const apiBase = CONFIG.getApiBase();
        
        // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„APIåœ°å€
        console.log('ğŸŒ ç¯å¢ƒæ£€æµ‹ç»“æœ:', {
            hostname: window.location.hostname,
            port: window.location.port,
            protocol: window.location.protocol,
            apiBase: apiBase,
            isProduction: !apiBase.includes('localhost') && !apiBase.includes('127.0.0.1')
        });
        
        // DOM å…ƒç´ 
        const loginBtn = document.getElementById('loginBtn');
        const status = document.getElementById('status');
        const userInfo = document.getElementById('userInfo');
        const apiTest = document.getElementById('apiTest');
        const envIndicator = document.getElementById('envIndicator');
        
        // åˆå§‹åŒ–ç¯å¢ƒæŒ‡ç¤ºå™¨
        function initEnvIndicator() {
            const isProduction = !apiBase.includes('localhost') && !apiBase.includes('127.0.0.1');
            const envType = isProduction ? 'production' : 'development';
            const envText = isProduction ? 'ç”Ÿäº§ç¯å¢ƒ' : 'å¼€å‘ç¯å¢ƒ';
            
            envIndicator.textContent = `${envText} - ${apiBase}`;
            envIndicator.className = `env-indicator ${envType}`;
        }
        
        // åˆå§‹åŒ–
        initEnvIndicator();
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'loading') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        // éšè—çŠ¶æ€ä¿¡æ¯
        function hideStatus() {
            status.style.display = 'none';
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo(user) {
            userInfo.innerHTML = `
                <h3>ç™»å½•æˆåŠŸ</h3>
                <p><strong>ç”¨æˆ·ID:</strong> ${user.id}</p>
                <p><strong>å§“å:</strong> ${user.name || 'æœªè®¾ç½®'}</p>
                <p><strong>é‚®ç®±:</strong> ${user.email || 'æœªè®¾ç½®'}</p>
                <p><strong>ç™»å½•æ—¶é—´:</strong> ${user.login_time ? new Date(user.login_time).toLocaleString() : 'æœªçŸ¥'}</p>
                <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            `;
            userInfo.style.display = 'block';
            
            // æ˜¾ç¤ºAPIæµ‹è¯•åŒºåŸŸ
            showApiTest();
        }
        
        // æ˜¾ç¤ºAPIæµ‹è¯•åŒºåŸŸ
        function showApiTest() {
            apiTest.innerHTML = `
                <h3>API æµ‹è¯•</h3>
                <button class="test-btn" onclick="testGetMe()">æµ‹è¯• /auth/me</button>
                <button class="test-btn" onclick="testSessionStatus()">æµ‹è¯• /auth/session/status</button>
                <div id="apiResult" class="api-result" style="display: none;"></div>
            `;
            apiTest.style.display = 'block';
        }
        
        // éšè—ç”¨æˆ·ä¿¡æ¯
        function hideUserInfo() {
            userInfo.style.display = 'none';
            apiTest.style.display = 'none';
        }
        
        // OAuth å¼¹çª—ç™»å½•
        function startOAuthLogin() {
            showStatus('æ­£åœ¨å¯åŠ¨ OAuth ç™»å½•...', 'loading');
            loginBtn.disabled = true;
            
            // æ„å»ºOAuthç™»å½•URLï¼ˆä½¿ç”¨popupå‚æ•°ï¼‰
            const oauthUrl = `${apiBase}/api/v2/auth/login?popup=true`;
            
            // æ‰“å¼€å¼¹çª—
            const popup = window.open(
                oauthUrl,
                'oauth_login',
                'width=600,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
            );
            
            if (!popup) {
                showStatus('æ— æ³•æ‰“å¼€å¼¹çª—ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—æ‹¦æˆªè®¾ç½®', 'error');
                loginBtn.disabled = false;
                return;
            }
            
            // ç›‘å¬å¼¹çª—å…³é—­æˆ–æ¶ˆæ¯
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    showStatus('OAuth ç™»å½•å·²å–æ¶ˆ', 'error');
                    loginBtn.disabled = false;
                }
            }, 1000);
            
            // ç›‘å¬æ¥è‡ªå¼¹çª—çš„æ¶ˆæ¯
            const messageHandler = (event) => {
                // éªŒè¯æ¶ˆæ¯æ¥æº
                if (event.origin !== window.location.origin && 
                    event.origin !== apiBase.replace(/\/api.*$/, '')) {
                    return;
                }
                
                if (event.data && event.data.type === 'oauth_result') {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', messageHandler);
                    popup.close();
                    
                    if (event.data.success) {
                        // ç™»å½•æˆåŠŸï¼Œè®¾ç½®cookie
                        if (event.data.session_id && event.data.user_id) {
                            // è®¾ç½®cookieï¼ˆ24å°æ—¶è¿‡æœŸï¼‰
                            const expires = new Date();
                            expires.setTime(expires.getTime() + (24 * 60 * 60 * 1000));
                            const cookieOptions = `expires=${expires.toUTCString()}; path=/; SameSite=Lax`;
                            
                            document.cookie = `session-id=${event.data.session_id}; ${cookieOptions}`;
                            document.cookie = `x-user-id=${event.data.user_id}; ${cookieOptions}`;
                            
                            console.log('âœ… Cookieå·²è®¾ç½®:', {
                                'session-id': event.data.session_id.substring(0, 8) + '...',
                                'x-user-id': event.data.user_id
                            });
                        }
                        
                        showStatus('ç™»å½•æˆåŠŸï¼', 'success');
                        showUserInfo(event.data.user);
                        loginBtn.textContent = 'é‡æ–°ç™»å½•';
                    } else {
                        showStatus(`ç™»å½•å¤±è´¥: ${event.data.message}`, 'error');
                    }
                    
                    loginBtn.disabled = false;
                }
            };
            
            window.addEventListener('message', messageHandler);
        }
        
        // ç™»å‡º
        async function logout() {
            try {
                showStatus('æ­£åœ¨ç™»å‡º...', 'loading');
                
                const response = await fetch(`${apiBase}/api/v2/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…é™¤æœ¬åœ°cookie
                    document.cookie = 'session-id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    document.cookie = 'x-user-id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    
                    console.log('âœ… Cookieå·²æ¸…é™¤');
                    
                    showStatus('ç™»å‡ºæˆåŠŸ', 'success');
                    hideUserInfo();
                    loginBtn.textContent = 'OAuth ç™»å½•';
                    setTimeout(hideStatus, 2000);
                } else {
                    showStatus(`ç™»å‡ºå¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`ç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯• /auth/me æ¥å£
        async function testGetMe() {
            try {
                const response = await fetch(`${apiBase}/api/v2/auth/me`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                showApiResult('GET /auth/me', response.status, result);
            } catch (error) {
                showApiResult('GET /auth/me', 'ERROR', { error: error.message });
            }
        }
        
        // æµ‹è¯• /auth/session/status æ¥å£
        async function testSessionStatus() {
            try {
                const response = await fetch(`${apiBase}/api/v2/auth/session/status`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                showApiResult('GET /auth/session/status', response.status, result);
            } catch (error) {
                showApiResult('GET /auth/session/status', 'ERROR', { error: error.message });
            }
        }
        
        // æ˜¾ç¤ºAPIæµ‹è¯•ç»“æœ
        function showApiResult(endpoint, status, data) {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = `
                <strong>${endpoint}</strong><br>
                <strong>çŠ¶æ€:</strong> ${status}<br>
                <strong>å“åº”:</strong><br>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            resultDiv.style.display = 'block';
        }
        
        // æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${apiBase}/api/v2/auth/session/status`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.authenticated) {
                    // è·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯
                    const userResponse = await fetch(`${apiBase}/api/v2/auth/me`, {
                        credentials: 'include'
                    });
                    
                    if (userResponse.ok) {
                        const userResult = await userResponse.json();
                        showUserInfo(userResult.user);
                        loginBtn.textContent = 'é‡æ–°ç™»å½•';
                    }
                }
            } catch (error) {
                console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        loginBtn.addEventListener('click', startOAuthLogin);
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', checkLoginStatus);
        
        // æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„APIåœ°å€
        console.log('å½“å‰APIåœ°å€:', apiBase);
    </script>
</body>
</html>